(function(a,b){function e(a){var b,c;window.console?(c=window.console.log,window.console.log=function(){a&&c.apply(console,arguments)}):(b=window.opera?window.opera.postError:alert,window.console={},window.console.log=function(c){a&&b(c)})}function f(a){var b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",c="",d,e;for(d=0;d<a;d++)e=Math.floor(Math.random()*b.length),c+=b.substring(e,e+1);return c}function g(a){var b,c,d,e,f,g;return b=Math.floor(a/3600),e=a%3600,c=Math.floor(e/60),f=e%60,d=Math.ceil(f),g={h:b,m:c,s:d},g}function h(){this.recursive_depth=3,this.aliases={},this.vars={version:1};var a=0;this.processInput=function(a){var b=a||[],c=this.aliases[b[0]],d,e="",f=[];if(!c)return a;c=c.split(" "),d=c.length;for(var g=0;g<d;g++){e=c[g];if(e[0]!=="$"){f.push(e);continue}if(!isNaN(e[1])){var h=e.match(/\$(\d+)(\+)?(\d+)?/);if(!h||!b[h[1]])continue;h[2]==="+"&&h[3]?f=f.concat(b.slice(parseInt(h[1],10),parseInt(h[1],10)+parseInt(h[3],10))):h[2]==="+"?f=f.concat(b.slice(parseInt(h[1],10))):f.push(b[parseInt(h[1],10)]);continue}if(typeof this.vars[e.substr(1)]!="undefined"){f.push(this.vars[e.substr(1)]);continue}}return f},this.process=function(b){b=b||"";var c=b.split(" ");return a++,a>=this.recursive_depth?(a--,b):(this.aliases[c[0]]&&(c=this.processInput(c),this.aliases[c[0]]&&(c=this.process(c.join(" ")).split(" "))),a--,c.join(" "))}}function i(a,b,c){var d,e,f,g,h,i;b/=100,c/=100;if(b==0)g=h=i=c*255;else{function j(a,b,c){var d;return c<0?c+=1:c>1&&(c-=1),6*c<1?d=a+(b-a)*c*6:2*c<1?d=b:3*c<2?d=a+(b-a)*(2/3-c)*6:d=a,255*d}c<=.5?e=c*(b+1):e=c+b-c*b,d=c*2-e,f=a/360,g=j(d,e,f+1/3),h=j(d,e,f),i=j(d,e,f-1/3)}return[g,h,i]}function j(a){var b,c;if(!a||typeof a!="string")return"";if(a.indexOf(String.fromCharCode(2))!==-1){c="<b>";while(a.indexOf(String.fromCharCode(2))!==-1)a=a.replace(String.fromCharCode(2),c),c=c==="<b>"?"</b>":"<b>";c==="</b>"&&(a+="</b>")}if(a.indexOf(String.fromCharCode(31))!==-1){c="<u>";while(a.indexOf(String.fromCharCode(31))!==-1)a=a.replace(String.fromCharCode(31),c),c=c==="<u>"?"</u>":"<u>";c==="</u>"&&(a+="</u>")}return a=function(a){var b,c,d,e,f,g,h,i,j,k;b="",c=function(a){var b=/^\x03([0-9][0-9]?)(,([0-9][0-9]?))?/;return b.exec(a)},d=function(a){switch(parseInt(a,10)){case 0:return"#FFFFFF";case 1:return"#000000";case 2:return"#000080";case 3:return"#008000";case 4:return"#FF0000";case 5:return"#800040";case 6:return"#800080";case 7:return"#FF8040";case 8:return"#FFFF00";case 9:return"#80FF00";case 10:return"#008080";case 11:return"#00FFFF";case 12:return"#0000FF";case 13:return"#FF55FF";case 14:return"#808080";case 15:return"#C0C0C0";default:return null}};if(a.indexOf("")!==-1){e=a.indexOf(""),b=a.substr(0,e);while(e<a.length)f=c(a.substr(e,6)),f?(g=a.indexOf("",e+1),h=a.indexOf(String.fromCharCode(15),e+1),h!==-1&&(g===-1?g=h:g=g<h?g:h),g===-1&&(g=a.length),i=d(f[1]),j=d(f[3]),k=a.substring(e+1+f[1].length+(j!==null?f[2].length:0),g),b+='<span style="'+(i!==null?"color: "+i+"; ":"")+(j!==null?"background-color: "+j+";":"")+'">'+k+"</span>",e=g):(a[e]!==""&&a[e]!==String.fromCharCode(15)&&(b+=a[e]),e++);return b}return a}(a),a}function k(a){return a=a||new Date,a.toLocaleDateString()+", "+a.getHours().toString()+":"+a.getMinutes().toString()+":"+a.getSeconds().toString()}var c={};c.model={},c.view={},c.applets={},c.global={settings:b,plugins:b,utils:b,user:b,server:b,channels:b,components:{EventComponent:function(a){function b(a,b){this.trigger(a,b)}_.extend(this,Backbone.Events),a.on("all",b,this),this.dispose=function(){a.off("all",b),this.off()}},Network:function(){var a=new this.EventComponent(c.gateway),b={kiwi:"kiwi",raw:"raw",kick:"kick",topic:"topic",part:"part",join:"join",action:"action",ctcp:"ctcp",notice:"notice",msg:"privmsg"};return _.each(b,function(b,d){a[d]=function(){var a=b;c.gateway[a].apply(c.gateway,arguments)}}),a},ControlInput:function(){var a=new this.EventComponent(c.app.controlbox),b={processInput:"run"};return _.each(b,function(b,d){a[d]=c.app.controlbox[b]}),a}},start:function(a){return a=a||{},c.global.plugins=new c.model.PluginManager,c.global.settings=c.model.DataStore.instance("kiwi.settings"),c.global.settings.load(),c.app=new c.model.Application(a),a.kiwi_server&&(c.app.kiwi_server=a.kiwi_server),c.app.start(),!0}};if(typeof a!="undefined")a.kiwi=c.global;else var d=c.global;c.model.Application=function(){var a=null,d={},f=function(){function f(b){a.panels.server.server_login.showError()}function h(a){var b=a.command+" "+a.params.join(" ");console.log("RAW: "+b),c.gateway.raw(b)}function i(a){}function j(b){var d,e;e=b.params.join(" ").split(","),$.each(e,function(b,e){e=e.trim(),d=a.panels.getByName(e),d||(d=new c.model.Channel({name:e}),c.app.panels.add(d)),c.gateway.join(e)}),d&&d.view.show()}function l(b){var d,e;d=b.params[0],e=a.panels.getByName(d),e||(e=new c.model.Query({name:d}),c.app.panels.add(e)),e&&e.view.show()}function m(b){var d=b.params[0],e=a.panels.getByName(d)||a.panels.server;b.params.shift(),e.addMsg(c.gateway.get("nick"),b.params.join(" ")),c.gateway.privmsg(d,b.params.join(" "))}function n(a){if(c.app.panels.active===c.app.panels.server)return;var b=c.app.panels.active;b.addMsg("","* "+c.gateway.get("nick")+" "+a.params.join(" "),"action"),c.gateway.action(b.get("name"),a.params.join(" "))}function o(a){a.params.length===0?c.gateway.part(c.app.panels.active.get("name")):_.each(a.params,function(a){c.gateway.part(a)})}function p(b){var d;if(b.params.length===0)return;a.isChannelName(b.params[0])?(d=b.params[0],b.params.shift()):d=c.app.panels.active.get("name"),c.gateway.topic(d,b.params.join(" "))}function q(a){var b;if(a.params.length<=1)return;b=a.params[0],a.params.shift(),c.gateway.notice(b,a.params.join(" "))}function r(a){var b=a.params.join(" ");c.gateway.raw(b)}function s(a){var b,d=c.app.panels.active;if(!d.isChannel())return;if(a.params.length===0)return;b=a.params[0],a.params.shift(),c.gateway.kick(d.get("name"),b,a.params.join(" "))}function t(a){if(c.app.panels.active.isServer()||c.app.panels.active.isApplet())return;c.app.panels.active.clearMessages&&c.app.panels.active.clearMessages()}function u(a){var b,d;if(a.params.length<2)return;b=a.params[0],a.params.shift(),d=a.params[0],a.params.shift(),c.gateway.ctcp(!0,d,b,a.params.join(" "))}function v(a){var b=c.model.Applet.loadOnce("kiwi_settings");b.view.show()}function w(a){var b=c.model.Applet.loadOnce("kiwi_script_editor");b.view.show()}function x(a){if(!a.params[0])return;var b=new c.model.Applet;if(a.params[1])b.load(a.params[0],a.params[1]);else if(c.applets[a.params[0]])b.load(new c.applets[a.params[0]]);else{c.app.panels.server.addMsg("",'Applet "'+a.params[0]+'" does not exist');return}c.app.panels.add(b),b.view.show()}this.panels=null,this.view=null,this.message=null,this.kiwi_server=null,this.initialize=function(b){a=this,b[0].container&&this.set("container",b[0].container),this.set("base_path",b[0].base_path?b[0].base_path:"/kiwi"),this.server_settings=b[0].server_settings||{},this.detectKiwiServer()},this.start=function(){getQueryVariable("debug")||e(!1),c.gateway=new c.model.Gateway,this.bindGatewayCommands(c.gateway),this.initializeClient(),this.initializeGlobals(),this.view.barsHide(!0),this.panels.server.server_login.bind("server_connect",function(b){var e=this,g="";d=b,e.networkConnecting(),g=a.kiwi_server+a.get("base_path")+"/transport/socket.io.js?ts="+(new Date).getTime(),$script(g,function(){if(!window.io){f();return}c.gateway.set("kiwi_server",a.kiwi_server+"/kiwi"),c.gateway.set("nick",b.nick),c.gateway.connect(b.server,b.port,b.ssl,b.password,function(a){a&&f()})})}),setTimeout(function(){c.app.panels.server.server_login.$el.find(".nick").select()},0)},this.detectKiwiServer=function(){window.location.protocol==="file:"?this.kiwi_server="http://localhost:7778":this.kiwi_server=window.location.protocol+"//"+window.location.host},this.initializeClient=function(){this.view=new c.view.Application({model:this,el:this.get("container")}),this.panels=new c.model.PanelList,this.controlbox=new c.view.ControlBox({el:$("#controlbox")[0]}),this.bindControllboxCommands(this.controlbox),this.topicbar=new c.view.TopicBar({el:$("#topic")[0]}),new c.view.AppToolbar({el:$("#toolbar .app_tools")[0]}),this.message=new c.view.StatusMessage({el:$("#status_message")[0]}),this.resize_handle=new c.view.ResizeHandler({el:$("#memberlists_resize_handle")[0]}),this.panels.server.view.show(),this.view.doLayout(),this.populateDefaultServerSettings()},this.initializeGlobals=function(){c.global.panels=this.panels,c.global.components.Applet=c.model.Applet,c.global.components.Panel=c.model.Panel},this.populateDefaultServerSettings=function(){var a,b={nick:getQueryVariable("nick")||"",server:"",port:6667,ssl:!1,channel:window.location.hash||"#chat",channel_key:""},c;this.server_settings.client&&(this.server_settings.client.nick&&(b.nick=this.server_settings.client.nick),this.server_settings.client.server&&(b.server=this.server_settings.client.server),this.server_settings.client.port&&(b.port=this.server_settings.client.port),this.server_settings.client.ssl&&(b.ssl=this.server_settings.client.ssl),this.server_settings.client.channel&&(b.channel=this.server_settings.client.channel)),a=window.location.pathname.toString().replace(this.get("base_path"),"").split("/"),a.length>0&&(a.shift(),a.length>0&&a[0]&&(c=a[0].substr(0,7).toLowerCase(),c==="ircs%3a"||c.substr(0,6)==="irc%3a"?(a[0]=decodeURIComponent(a[0]),c=/^irc(s)?:(?:\/\/?)?([^:\/]+)(?::([0-9]+))?(?:(?:\/)([^\?]*)(?:(?:\?)(.*))?)?$/.exec(a[0]),c&&(typeof c[1]!="undefined"&&(b.ssl=!0,b.port===6667&&(b.port=6697)),b.server=c[2],typeof c[3]!="undefined"&&(b.port=c[3]),typeof c[4]!="undefined"&&(b.channel="#"+c[4],typeof c[5]!="undefined"&&(b.channel_key=c[5]))),a=[]):(a[0].search(/:/)>0?(b.port=a[0].substring(a[0].search(/:/)+1),b.server=a[0].substring(0,a[0].search(/:/)),b.port[0]==="+"?(b.port=parseInt(b.port.substring(1),10),b.ssl=!0):b.ssl=!1):b.server=a[0],a.shift())),a.length>0&&a[0]&&(b.channel="#"+a[0],a.shift())),this.server_settings&&this.server_settings.connection&&(this.server_settings.connection.server&&(b.server=this.server_settings.connection.server),this.server_settings.connection.port&&(b.port=this.server_settings.connection.port),this.server_settings.connection.ssl&&(b.ssl=this.server_settings.connection.ssl),this.server_settings.connection.channel&&(b.channel=this.server_settings.connection.channel),this.server_settings.connection.nick&&(b.nick=this.server_settings.connection.nick)),b.nick=b.nick.replace("?",Math.floor(Math.random()*1e5).toString()),this.panels.server.server_login.populateFields(b)},this.bindGatewayCommands=function(e){e.on("onmotd",function(b){a.panels.server.addMsg(c.gateway.get("name"),b.msg,"motd")}),e.on("onconnect",function(b){a.view.barsShow(),d.channel&&a.controlbox.processInput("/JOIN "+d.channel+" "+d.channel_key)}),function(){var b=0;e.on("disconnect",function(d){var e="You have been disconnected. Attempting to reconnect for you..";a.message.text(e,{timeout:1e4}),$.each(c.app.panels.models,function(a,b){if(!b||!b.isChannel())return;b.addMsg("",e,"action quit")}),c.app.panels.server.addMsg("",e,"action quit"),b=1}),e.on("reconnecting",function(a){msg="You have been disconnected. Attempting to reconnect again in "+a.delay/1e3+" seconds..",c.app.panels.server.addMsg("",msg,"action quit")}),e.on("connect",function(d){if(b!==1)return;var e="It's OK, you're connected again :)";a.message.text(e,{timeout:5e3}),$.each(c.app.panels.models,function(a,b){if(!b||!b.isChannel())return;b.addMsg("",e,"action join")}),c.app.panels.server.addMsg("",e,"action join"),b=0})}(),e.on("onjoin",function(b){var d,e,f;d=a.panels.getByName(b.channel),d||(d=new c.model.Channel({name:b.channel}),a.panels.add(d)),e=d.get("members");if(!e)return;f=new c.model.Member({nick:b.nick,ident:b.ident,hostname:b.hostname}),e.add(f)}),e.on("onpart",function(b){var d,e,f,g={};g.type="part",g.message=b.message||"",d=a.panels.getByName(b.channel);if(!d)return;if(b.nick===c.gateway.get("nick")){d.close();return}e=d.get("members");if(!e)return;f=e.getByNick(b.nick);if(!f)return;e.remove(f,g)}),e.on("onquit",function(b){var c,d,e={};e.type="quit",e.message=b.message||"",$.each(a.panels.models,function(a,d){if(!d.isChannel())return;c=d.get("members").getByNick(b.nick),c&&d.get("members").remove(c,e)})}),e.on("onkick",function(b){var d,e,f,g={};g.type="kick",g.by=b.nick,g.message=b.message||"",d=a.panels.getByName(b.channel);if(!d)return;e=d.get("members");if(!e)return;f=e.getByNick(b.kicked);if(!f)return;e.remove(f,g),b.kicked===c.gateway.get("nick")&&e.reset([])}),e.on("onmsg",function(b){var d,e=b.channel==c.gateway.get("nick");e?(d=a.panels.getByName(b.nick),d||(d=new c.model.Query({name:b.nick}),a.panels.add(d))):(d=a.panels.getByName(b.channel),d||(d=a.panels.server)),d.addMsg(b.nick,b.msg)}),e.on("onctcp_request",function(a){a.msg.toUpperCase()==="TIME"&&e.ctcp(!1,a.type,a.nick,(new Date).toString())}),e.on("onctcp_response",function(b){a.panels.server.addMsg("["+b.nick+"]","CTCP "+b.msg)}),e.on("onnotice",function(b){var c;c=a.panels.getByName(b.target)||a.panels.getByName(b.nick),c||(c=a.panels.server),c.addMsg("["+(b.nick||"")+"]",b.msg)}),e.on("onaction",function(b){var d,e=b.channel==c.gateway.get("nick");e?(d=a.panels.getByName(b.nick),d||(d=new c.model.Channel({name:b.nick}),a.panels.add(d))):(d=a.panels.getByName(b.channel),d||(d=a.panels.server)),d.addMsg("","* "+b.nick+" "+b.msg,"action")}),e.on("ontopic",function(b){var d;d=a.panels.getByName(b.channel);if(!d)return;d.set("topic",b.topic),d.get("name")===c.app.panels.active.get("name")&&a.topicbar.setCurrentTopic(b.topic)}),e.on("ontopicsetby",function(b){var c,d;c=a.panels.getByName(b.channel);if(!c)return;d=k(new Date(b.when*1e3)),c.addMsg("","Topic set by "+b.nick+" at "+d,"topic")}),e.on("onuserlist",function(b){var d;d=a.panels.getByName(b.channel);if(!d)return;d.temp_userlist=d.temp_userlist||[],_.each(b.users,function(a){var b=new c.model.Member({nick:a.nick,modes:a.modes});d.temp_userlist.push(b)})}),e.on("onuserlist_end",function(b){var c;c=a.panels.getByName(b.channel);if(!c)return;c.get("members").reset(c.temp_userlist||[]),delete c.temp_userlist}),e.on("onmode",function(b){function j(a,c){var d={},e;return a||(a=b.modes,c=b.target),_.each(a,function(a){var b=a.param||c||"";d[b]||(d[b]={"+":"","-":""}),d[b][a.mode[0]]+=a.mode.substr(1)}),e=[],_.each(d,function(a,b){var c="";a["+"]&&(c+="+"+a["+"]),a["-"]&&(c+="-"+a["-"]),e.push(c+" "+b)}),e=e.join(", "),e}var d,e,f,g,h,i;d=a.panels.getByName(b.target);if(d){f=c.gateway.get("user_prefixes"),i=function(a){return b.modes[e].mode[1]===a.mode};for(e=0;e<b.modes.length;e++)if(_.any(f,i)){g||(g=d.get("members")),h=g.getByNick(b.modes[e].param);if(!h){console.log("MODE command recieved for unknown member %s on channel %s",b.modes[e].param,b.target);return}b.modes[e].mode[0]==="+"?h.addMode(b.modes[e].mode[1]):b.modes[e].mode[0]==="-"&&h.removeMode(b.modes[e].mode[1]),g.sort()}d.addMsg("","== "+b.nick+" sets mode "+j(),"action mode")}else b.target.toLowerCase()===c.gateway.get("nick").toLowerCase()?a.panels.server.addMsg("","== "+b.nick+" set mode "+j(),"action mode"):console.log("MODE command recieved for unknown target %s: ",b.target,b)}),e.on("onnick",function(b){var c;$.each(a.panels.models,function(a,d){if(!d.isChannel())return;c=d.get("members").getByNick(b.nick),c&&(c.set("nick",b.newnick),d.addMsg("","== "+b.nick+" is now known as "+b.newnick,"action nick"))})}),e.on("onwhois",function(a){var b,d="",e;if(a.end)return;typeof a.idle!="undefined"&&(d=g(parseInt(a.idle,10)),d=d.h.toString().lpad(2,"0")+":"+d.m.toString().lpad(2,"0")+":"+d.s.toString().lpad(2,"0")),e=c.app.panels.active,a.ident?e.addMsg(a.nick,a.nick+" ["+a.nick+"!"+a.ident+"@"+a.host+"] * "+a.msg,"whois"):a.chans?e.addMsg(a.nick,"Channels: "+a.chans,"whois"):a.irc_server?e.addMsg(a.nick,"Connected to server: "+a.irc_server,"whois"):a.msg?e.addMsg(a.nick,a.msg,"whois"):a.logon?(b=new Date,b.setTime(a.logon*1e3),b=k(b),e.addMsg(a.nick,"idle for "+d+", signed on "+b,"whois")):e.addMsg(a.nick,"idle for "+d,"whois")}),e.on("onaway",function(b){$.each(a.panels.models,function(a,c){if(!c.isChannel())return;member=c.get("members").getByNick(b.nick),member&&member.set("away",!!b.trailing)})}),e.on("onlist_start",function(a){c.app.channel_list&&(c.app.channel_list.close(),delete c.app.channel_list);var b=new c.model.Applet,d=new c.applets.Chanlist;b.load(d),c.app.panels.add(b),b.view.show(),c.app.channel_list=d}),e.on("onlist_channel",function(a){c.app.channel_list.addChannel(a.chans)}),e.on("onlist_end",function(a){delete c.app.channel_list}),e.on("onirc_error",function(d){var e,f;d.channel!==b&&!(e=c.app.panels.getByName(d.channel))&&(e=c.app.panels.server);switch(d.error){case"banned_from_channel":e.addMsg(" ","== You are banned from "+d.channel+". "+d.reason,"status"),c.app.message.text("You are banned from "+d.channel+". "+d.reason);break;case"bad_channel_key":e.addMsg(" ","== Bad channel key for "+d.channel,"status"),c.app.message.text("Bad channel key or password for "+d.channel);break;case"invite_only_channel":e.addMsg(" ","== "+d.channel+" is invite only.","status"),c.app.message.text(d.channel+" is invite only");break;case"channel_is_full":e.addMsg(" ","== "+d.channel+" is full.","status"),c.app.message.text(d.channel+" is full");break;case"chanop_privs_needed":e.addMsg(" ","== "+d.reason,"status"),c.app.message.text(d.reason+" ("+d.channel+")");break;case"no_such_nick":f=c.app.panels.getByName(d.nick),f?f.addMsg(" ","== "+d.nick+": "+d.reason,"status"):c.app.panels.server.addMsg(" ","== "+d.nick+": "+d.reason,"status");break;case"nickname_in_use":c.app.panels.server.addMsg(" ","== The nickname "+d.nick+" is already in use. Please select a new nickname","status"),c.app.panels.server!==c.app.panels.active&&c.app.message.text('The nickname "'+d.nick+'" is already in use. Please select a new nickname'),a.controlbox.$el.css("display")!=="none"&&(new c.view.NickChangeBox).render();case"password_mismatch":c.app.panels.server.addMsg(" ","== Incorrect password given","status");break;default:}})},this.bindControllboxCommands=function(a){$.extend(a.preprocessor.aliases,{"/p":"/part $1+","/me":"/action $1+","/j":"/join $1+","/q":"/query $1+","/op":"/quote mode $channel +o $1+","/deop":"/quote mode $channel -o $1+","/hop":"/quote mode $channel +h $1+","/dehop":"/quote mode $channel -h $1+","/voice":"/quote mode $channel +v $1+","/devoice":"/quote mode $channel -v $1+","/k":"/kick $channel $1+","/slap":"/me slaps $1 around a bit with a large trout"}),a.on("unknown_command",h),a.on("command",i),a.on("command:msg",m),a.on("command:action",n),a.on("command:join",j),a.on("command:part",o),a.on("command:nick",function(a){c.gateway.changeNick(a.params[0])}),a.on("command:query",l),a.on("command:topic",p),a.on("command:notice",q),a.on("command:quote",r),a.on("command:kick",s),a.on("command:clear",t),a.on("command_ctcp",u),a.on("command:css",function(a){var b="?reload="+(new Date).getTime();$('link[rel="stylesheet"]').each(function(){this.href=this.href.replace(/\?.*|$/,b)})}),a.on("command:js",function(a){if(!a.params[0])return;$script(a.params[0]+"?"+(new Date).getTime())}),a.on("command:set",function(a){if(!a.params[0])return;var b=a.params[0],d;a.params[1]&&(a.params.shift(),d=a.params.join(" "),c.global.settings.set(b,d)),c.app.panels.active.addMsg("",b+" = "+c.global.settings.get(b))}),a.on("command:save",function(a){c.global.settings.save(),c.app.panels.active.addMsg("","Settings have been saved")}),a.on("command:alias",function(b){var d,e;if(!b.params[1]){$.each(a.preprocessor.aliases,function(a,b){c.app.panels.server.addMsg(" ",a+"   =>   "+b)});return}if(b.params[0]==="del"||b.params[0]==="delete"){d=b.params[1],d[0]!=="/"&&(d="/"+d),delete a.preprocessor.aliases[d];return}d=b.params[0],b.params.shift(),e=b.params.join(" "),d[0]!=="/"&&(d="/"+d),a.preprocessor.aliases[d]=e}),a.on("command:applet",x),a.on("command:settings",v),a.on("command:script",w)},this.isChannelName=function(a){var b=c.gateway.get("channel_prefix");return!a||!a.length?!1:b.indexOf(a[0])>-1}};return f=Backbone.Model.extend(new f),new f(arguments)},c.model.Gateway=function(){var a=null;return this.defaults={name:"Server",address:"",nick:"",channel_prefix:"#",user_prefixes:["~","&","@","+"],kiwi_server:"//kiwi"},this.initialize=function(){a=this,this.socket=this.get("socket"),this.applyEventHandlers()},this.applyEventHandlers=function(){var a=this;this.on("onmsg",function(b){var c,d=b.channel==a.get("nick");c=d?b.nick:b.channel,a.trigger("message:"+c,b),a.trigger("message",b),d&&(a.trigger("pm:"+c,b),a.trigger("pm",b))},this),this.on("onnotice",function(a){var b=a.target||a.nick;this.trigger("notice:"+b,a),this.trigger("notice",a)},this),this.on("onaction",function(b){var c,d=b.channel==a.get("nick");c=d?b.nick:b.channel,a.trigger("action:"+c,b),d&&(a.trigger("action:"+c,b),a.trigger("action",b))},this),this.on("ontopic",function(b){a.trigger("topic:"+b.channel,b),a.trigger("topic",b)}),this.on("onjoin",function(b){a.trigger("join:"+b.channel,b),a.trigger("join",b)})},this.connect=function(b,d,e,f,g){var h;c.app.get("base_path").substr(0,1)==="/"?(h=c.app.get("base_path"),h=h.substr(1,h.length-1),h+="/transport"):h=c.app.get("base_path")+"/transport",this.socket=io.connect(this.get("kiwi_server"),{resource:h,"try multiple transports":!0,"connect timeout":3e3,"max reconnection attempts":7,"reconnection delay":2e3,"sync disconnect on unload":!1}),this.socket.on("connect_failed",function(a){this.socket.disconnect(),this.trigger("connect_fail",{reason:a})}),this.socket.on("error",function(b){console.log("_kiwi.gateway.socket.on('error')",{reason:b}),a.trigger("connect_fail",{reason:b})}),this.socket.on("connecting",function(b){console.log("_kiwi.gateway.socket.on('connecting')"),a.trigger("connecting")}),this.socket.on("connect",function(){this.emit("kiwi",{command:"connect",nick:a.get("nick"),hostname:b,port:d,ssl:e,password:f},function(b,c){b?(console.log("_kiwi.gateway.socket.on('error')",{reason:b}),g(b)):(a.server_num=c,console.log("_kiwi.gateway.socket.on('connect')"))})}),this.socket.on("too_many_connections",function(){a.trigger("connect_fail",{reason:"too_many_connections"})}),this.socket.on("irc",function(b,c){a.parse(b.command,b.data)}),this.socket.on("kiwi",function(b,c){a.parseKiwi(b.command,b.data)}),this.socket.on("disconnect",function(){a.trigger("disconnect",{}),console.log("_kiwi.gateway.socket.on('disconnect')")}),this.socket.on("close",function(){console.log("_kiwi.gateway.socket.on('close')")}),this.socket.on("reconnecting",function(b,c){console.log("_kiwi.gateway.socket.on('reconnecting')"),a.trigger("reconnecting",{delay:b,attempts:c})}),this.socket.on("reconnect_failed",function(){console.log("_kiwi.gateway.socket.on('reconnect_failed')")})},this.isConnected=function(){return this.socket.socket.connected},this.parseKiwi=function(a,b){this.trigger("kiwi:"+a,b),this.trigger("kiwi",b)},this.parse=function(c,d){if(c!==b){a.trigger("on"+c,d);switch(c){case"options":$.each(d.options,function(b,c){switch(b){case"CHANTYPES":a.set("channel_prefix",c.join("").charAt(0));break;case"NETWORK":a.set("name",c);break;case"PREFIX":a.set("user_prefixes",c)}}),a.set("cap",d.cap);break;case"connect":a.set("nick",d.nick);break;case"nick":d.nick===a.get("nick")&&a.set("nick",d.newnick);break;case"kiwi":this.emit("_kiwi."+d.namespace,d.data)}}},this.sendData=function(a,b){this.socket.emit("irc",{server:0,data:JSON.stringify(a)},b)},this.privmsg=function(a,b,c){var d={method:"privmsg",args:{target:a,msg:b}};this.sendData(d,c)},this.notice=function(a,b,c){var d={method:"notice",args:{target:a,msg:b}};this.sendData(d,c)},this.ctcp=function(a,b,c,d,e){var f={method:"ctcp",args:{request:a,type:b,target:c,params:d}};this.sendData(f,e)},this.action=function(a,b,c){this.ctcp(!0,"ACTION",a,b,c)},this.join=function(a,b,c){var d={method:"join",args:{channel:a,key:b}};this.sendData(d,c)},this.part=function(a,b){var c={method:"part",args:{channel:a}};this.sendData(c,b)},this.topic=function(a,b,c){var d={method:"topic",args:{channel:a,topic:b}};this.sendData(d,c)},this.kick=function(a,b,c,d){var e={method:"kick",args:{channel:a,nick:b,reason:c}};this.sendData(e,d)},this.quit=function(a,b){a=a||"";var c={method:"quit",args:{message:a}};this.sendData(c,b)},this.raw=function(a,b){a={method:"raw",args:{data:a}},this.sendData(a,b)},this.changeNick=function(a,b){var c={method:"nick",args:{nick:a}};this.sendData(c,b)},this.kiwi=function(a,b,c){b={method:"kiwi",args:{target:a,data:b}},this.sendData(b,c)},new(Backbone.Model.extend(this))(arguments)},c.model.Member=Backbone.Model.extend({sortModes:function(a){return a.sort(function(a,b){var d,e,f,g=c.gateway.get("user_prefixes");for(f=0;f<g.length;f++)g[f].mode===a&&(d=f);for(f=0;f<g.length;f++)g[f].mode===b&&(e=f);return d<e?-1:d>e?1:0})},initialize:function(a){var b,c,d;b=this.stripPrefix(this.get("nick")),c=this.get("modes"),c=c||[],this.sortModes(c),this.set({nick:b,modes:c,prefix:this.getPrefix(c)},{silent:!0})},addMode:function(a){var b=a.split(""),c,d;c=this.get("modes"),$.each(b,function(a,b){c.push(b)}),c=this.sortModes(c),this.set({prefix:this.getPrefix(c),modes:c})},removeMode:function(a){var b=a.split(""),c,d;c=this.get("modes"),c=_.reject(c,function(a){return _.indexOf(b,a)!==-1}),this.set({prefix:this.getPrefix(c),modes:c})},getPrefix:function(a){var b="",d=c.gateway.get("user_prefixes");return typeof a[0]!="undefined"&&(b=_.detect(d,function(b){return b.mode===a[0]}),b=b?b.symbol:""),b},stripPrefix:function(a){var b=a,d,e,f,g=c.gateway.get("user_prefixes");d=0;for(e=0;e<a.length;e++)for(f=0;f<g.length;f++)if(a.charAt(e)===g[f].symbol){d++;break}return b.substr(d)},displayNick:function(a){var b=this.get("nick");return a&&this.get("ident")&&(b+=" ["+this.get("ident")+"@"+this.get("hostname")+"]"),b}}),c.model.MemberList=Backbone.Collection.extend({model:c.model.Member,comparator:function(a,b){var d,e,f,g,h,i,j,k=c.gateway.get("user_prefixes");e=a.get("modes"),f=b.get("modes");if(e.length>0){if(f.length===0)return-1;g=h=-1;for(d=0;d<k.length;d++)k[d].mode===e[0]&&(g=d);for(d=0;d<k.length;d++)k[d].mode===f[0]&&(h=d);if(g<h)return-1;if(g>h)return 1}else if(f.length>0)return 1;return i=a.get("nick").toLocaleUpperCase(),j=b.get("nick").toLocaleUpperCase(),i<j?-1:i>j?1:0},initialize:function(a){this.view=new c.view.MemberList({model:this})},getByNick:function(a){if(typeof a!="string")return;return this.find(function(b){return a.toLowerCase()===b.get("nick").toLowerCase()})}}),c.model.Panel=Backbone.Model.extend({initialize:function(a){var b=this.get("name")||"";this.view=new c.view.Panel({model:this,name:b}),this.set({scrollback:[],name:b},{silent:!0})},addMsg:function(a,b,d,e){var f,g,h,i=parseInt(c.global.settings.get("scrollback"),10)||250;e=e||{};if(!e||typeof e.time=="undefined")h=new Date,e.time=h.getHours().toString().lpad(2,"0")+":"+h.getMinutes().toString().lpad(2,"0")+":"+h.getSeconds().toString().lpad(2,"0");if(!e||typeof e.style=="undefined")e.style="";f={msg:b,time:e.time,nick:a,chan:this.get("name"),type:d,style:e.style};if(!f)return;typeof f.type!="string"&&(f.type=""),typeof f.msg!="string"&&(f.msg=""),g=this.get("scrollback"),g.push(f),g.length>i&&g.splice(i),this.set({scrollback:g},{silent:!0}),this.trigger("msg",f)},clearMessages:function(){this.set({scrollback:[]},{silent:!0}),this.addMsg("","Window cleared"),this.view.render()},closePanel:function(){this.view&&(this.view.unbind(),this.view.remove(),this.view=b,delete this.view);var a=this.get("members");a&&(a.reset([]),this.unset("members")),c.app.panels.remove(this),this.unbind(),this.destroy(),this.cid===c.app.panels.active.cid&&c.app.panels.server.view.show()},close:function(){return this.closePanel()},isChannel:function(){var a=c.gateway.get("channel_prefix"),b=this.get("name");return this.isApplet()||!b?!1:a.indexOf(b[0])>-1},isApplet:function(){return this.applet?!0:!1},isServer:function(){return this.server?!0:!1},isActive:function(){return c.app.panels.active===this}}),c.model.PanelList=Backbone.Collection.extend({model:c.model.Panel,comparator:function(a){return a.get("name")},initialize:function(){this.view=new c.view.Tabs({el:$("#tabs")[0],model:this}),this.add(new c.model.Server({name:c.gateway.get("name")})),this.server=this.getByName(c.gateway.get("name")),this.active=null,this.bind("active",function(a){this.active=a},this)},getByName:function(a){if(typeof a!="string")return;return this.find(function(b){return a.toLowerCase()===b.get("name").toLowerCase()})}}),c.model.Query=c.model.Panel.extend({initialize:function(a){var b=this.get("name")||"",d;this.view=new c.view.Channel({model:this,name:b}),this.set({name:b,scrollback:[]},{silent:!0})}}),c.model.Channel=c.model.Panel.extend({initialize:function(a){var b=this.get("name")||"",d;this.view=new c.view.Channel({model:this,name:b}),this.set({members:new c.model.MemberList,name:b,scrollback:[],topic:""},{silent:!0}),d=this.get("members"),d.bind("add",function(a){var b=c.global.settings.get("show_joins_parts");if(b===!1)return;this.addMsg(" ","== "+a.displayNick(!0)+" has joined","action join")},this),d.bind("remove",function(a,b,d){var e=c.global.settings.get("show_joins_parts");if(e===!1)return;var f=d.message?"("+d.message+")":"";d.type==="quit"?this.addMsg(" ","== "+a.displayNick(!0)+" has quit "+f,"action quit"):d.type==="kick"?this.addMsg(" ","== "+a.displayNick(!0)+" was kicked by "+d.by+" "+f,"action kick"):this.addMsg(" ","== "+a.displayNick(!0)+" has left "+f,"action part")},this)}}),c.model.Server=c.model.Panel.extend({server:!0,initialize:function(a){var b="Server";this.view=new c.view.Panel({model:this,name:b}),this.set({scrollback:[],name:b},{silent:!0}),this.server_login=new c.view.ServerSelect,this.view.$el.append(this.server_login.$el),this.server_login.show()}}),c.model.Applet=c.model.Panel.extend({applet:!0,initialize:function(a){var b="applet_"+(new Date).getTime().toString()+Math.ceil(Math.random()*100).toString();this.view=new c.view.Applet({model:this,name:b}),this.set({name:b},{silent:!0}),this.loaded_applet=null},load:function(a,b){if(typeof a=="object"){if(a.get||a.extend)this.set("title",a.get("title")||"Unknown Applet"),a.bind("change:title",function(a,b){this.set("title",b)},this),this.view.$el.html(""),a.view&&this.view.$el.append(a.view.$el),this.loaded_applet=a,this.loaded_applet.trigger("applet_loaded")}else typeof a=="string"&&this.loadFromUrl(a,b);return this},loadFromUrl:function(a,b){var d=this;this.view.$el.html("Loading.."),$script(a,function(){if(!c.applets[b]){d.view.$el.html("Not found");return}d.load(new c.applets[b])})},close:function(){this.view.$el.remove(),this.destroy(),this.view=b,this.loaded_applet&&this.loaded_applet.dispose&&this.loaded_applet.dispose(),this.closePanel()}},{loadOnce:function(a){var b=_.find(c.app.panels.models,function(b){if(!b.isApplet())return;if(!b.loaded_applet)return;if(b.loaded_applet.get("_applet_name")===a)return!0});return b?b:this.load(a)},load:function(a){var b;if(!c.applets[a])return;return b=new c.model.Applet,b.load(new c.applets[a]({_applet_name:a})),c.app.panels.add(b),b},register:function(a,b){c.applets[a]=b}}),c.model.PluginManager=Backbone.Model.extend({initialize:function(){this.$plugin_holder=$('<div id="kiwi_plugins" style="display:none;"></div>').appendTo("#kiwi"),this.loaded_plugins={}},load:function(a){this.loaded_plugins[a]&&this.unload(a),this.loaded_plugins[a]=$("<div></div>"),this.loaded_plugins[a].appendTo(this.$plugin_holder).load(a)},unload:function(a){if(!this.loaded_plugins[a])return;this.loaded_plugins[a].remove(),delete this.loaded_plugins[a]}}),c.model.DataStore=Backbone.Model.extend({initialize:function(){this._namespace="",this.new_data={}},namespace:function(a){return a&&(this._namespace=a),this._namespace},save:function(){localStorage.setItem(this._namespace,JSON.stringify(this.attributes))},load:function(){if(!localStorage)return;var a;try{a=JSON.parse(localStorage.getItem(this._namespace))||{}}catch(b){a={}}this.attributes=a}},{instance:function(a,b){var d=new c.model.DataStore(b);return d.namespace(a),d}}),function(){var a=Backbone.View.extend({events:{"click .save":"saveSettings"},initialize:function(a){this.$el=$($("#tmpl_applet_settings").html()),c.global.settings.on("change",this.loadSettings,this),this.loadSettings()},loadSettings:function(){var a=c.global.settings,b=a.get("theme")||"relaxed";this.$el.find(".setting-theme option").filter(function(){return $(this).val()===b}).attr("selected",!0);var d=a.get("channel_list_style")||"tabs";this.$el.find(".setting-channel_list_style option").filter(function(){return $(this).val()===d}).attr("selected",!0),this.$el.find(".setting-scrollback").val(a.get("scrollback")||"250"),typeof a.get("show_joins_parts")=="undefined"||a.get("show_joins_parts")?this.$el.find(".setting-show_joins_parts").attr("checked",!0):this.$el.find(".setting-show_joins_parts").attr("checked",!1)},saveSettings:function(){var a=c.global.settings;c.global.settings.off("change",this.loadSettings,this),a.set("theme",$(".setting-theme",this.$el).val()),a.set("channel_list_style",$(".setting-channel_list_style",this.$el).val()),a.set("scrollback",$(".setting-scrollback",this.$el).val()),a.set("show_joins_parts",$(".setting-show_joins_parts",this.$el).is(":checked")),a.save(),c.global.settings.on("change",this.loadSettings,this)}}),b=Backbone.Model.extend({initialize:function(){this.set("title","Settings"),this.view=new a}});c.model.Applet.register("kiwi_settings",b)}(),function(){var a=Backbone.View.extend({events:{"click .save":"saveSettings"},initialize:function(a){this.$el=$($("#tmpl_applet_settings").html())},saveSettings:function(){var a=$(".theme",this.$el).val(),b=$("#panels > .panel_container");b.removeClass(function(a,b){return(b.match(/\btheme_\S+/g)||[]).join(" ")}),a&&b.addClass("theme_"+a)}});c.applets.nickserv=Backbone.Model.extend({initialize:function(){this.set("title","Nickserv Login"),c.global.control.on("command:login",this.loginCommand,this)},loginCommand:function(a){console.log("waheeyy")}})}(),function(){var a=Backbone.View.extend({events:{},initialize:function(a){this.$el=$($("#tmpl_channel_list").html()),this.channels=[],this.ordered=!1,this.waiting=!1},render:function(){var a=$("table",this.$el),b=a.children("tbody:first").detach();this.ordered&&this.channels.sort(function(a,b){return b.num_users-a.num_users}),_.each(this.channels,function(a){b.append(a.html)}),a.append(b)}});c.applets.Chanlist=Backbone.Model.extend({initialize:function(){this.set("title","Channel List"),this.view=new a},addChannel:function(a){var b=this;_.isArray(a)||(a=[a]),_.each(a,function(a){var c,d;c='<tr><td><a class="chan">'+_.escape(a.channel)+'</a></td><td class="num_users" style="text-align: center;">'+a.num_users+'</td><td style="padding-left: 2em;">'+j(_.escape(a.topic))+"</td></tr>",a.html=c,b.view.channels.push(a)}),b.view.waiting||(b.view.waiting=!0,_.defer(function(){b.view.render(),b.view.waiting=!1}))},dispose:function(){this.view.channels=null,this.view.unbind(),this.view.$el.html(""),this.view.remove(),this.view=null}})}(),function(){var a=Backbone.View.extend({events:{"click .btn_save":"onSave"},initialize:function(a){var b=this;this.$el=$($("#tmpl_script_editor").html()),this.model.on("applet_loaded",function(){b.$el.parent().css("height","100%"),$script("https://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js",function(){b.createAce()})})},createAce:function(){var a="editor_"+Math.floor(Math.random()*1e7).toString();this.editor_id=a,this.$el.find(".editor").attr("id",a),this.editor=ace.edit(a),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/javascript");var b=c.global.settings.get("user_script")||"";this.editor.setValue(b)},onSave:function(a){var b,d;b="var network = kiwi.components.Network();\n",b+="var input = kiwi.components.ControlInput();\n",b+=this.editor.getValue()+"\n",b+="this._dispose = function(){ network.off(); if(this.dispose) this.dispose(); }";try{d=new Function(b),c.user_script&&c.user_script._dispose&&c.user_script._dispose(),c.user_script=new d}catch(e){this.setStatus("Script error. "+e.toString());return}c.global.settings.set("user_script",this.editor.getValue()),c.global.settings.save(),this.setStatus("Your script has been saved and is now active :)")},setStatus:function(a){var b=this.$el.find(".toolbar .status");a=a||"",b.slideUp("fast",function(){b.text(a),b.slideDown()})}}),b=Backbone.Model.extend({initialize:function(){var b=this;this.set("title","Script Editor"),this.view=new a({model:this})}});c.model.Applet.register("kiwi_script_editor",b)}(),typeof String.prototype.trim=="undefined"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),typeof String.prototype.lpad=="undefined"&&(String.prototype.lpad=function(a,b){var c="",d;for(d=0;d<a;d++)c+=b;return(c+this).slice(-a)});var l=[{name:"images",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/^((https?\:\/\/|ftp\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?(\.jpg|\.jpeg|\.gif|\.bmp|\.png)$/gi,function(b){a.event_bubbles=!1;var c='<img class="link_img_a" src="'+b+'" height="100%" width="100%" />';return'<a class="link_ext link_img" target="_blank" rel="nofollow" href="'+b+'" style="height:50px;width:50px;display:block">'+c+'<div class="tt box"></div></a>'}),a):a}},{name:"html_safe",onaddmsg:function(a,b){return a.msg=$("<div/>").text(a.msg).html(),a.nick=$("<div/>").text(a.nick).html(),a}},{name:"activity",onaddmsg:function(a,b){return a}},{name:"highlight",onaddmsg:function(a,b){return a}},{name:"linkify_plain",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/((https?\:\/\/|ftp\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi,function(a){var b;return a.match(/(\.jpg|\.jpeg|\.gif|\.bmp|\.png)$/)?a:(b=a,a.match("^https?://")?b=a:a="http://"+a,'<a class="link_ext" target="_blank" rel="nofollow" href="'+a+'">'+b+"</a>")}),a):a}},{name:"lftobr",onaddmsg:function(a,b){return a.msg?(a.msg=a.msg.replace(/\n/gi,function(a){return"<br/>"}),a):a}},{name:"nick_colour",onaddmsg:function(a,b){if(!a.msg)return a;var c=this.randColour();return a.nick='<span style="color:'+c+';">'+a.nick+"</span>",a},randColour:function(){var a=this.rand(-250,0),b=this.rand(30,100),c=this.rand(20,70);return"hsl("+a+","+b+"%,"+c+"%)"},rand:function(a,b){return parseInt(Math.random()*(b-a+1),10)+a}},{name:"kiwitest",oninit:function(a,b){console.log("registering namespace"),$(gateway).bind("_kiwi.lol.browser",function(a,b){console.log("YAY kiwitest"),console.log(b)})}}];c.dataStore=function(a){var b=a;this.get=function(b){return $.jStorage.get(a+"_"+b)},this.set=function(b,c){return $.jStorage.set(a+"_"+b,c)}},c.data=new c.dataStore("kiwi"),function(a){function i(){if("localStorage"in window)try{window.localStorage&&(c=window.localStorage,h="localStorage")}catch(a){}else if("globalStorage"in window)try{window.globalStorage&&(c=window.globalStorage[window.location.hostname],h="globalStorage")}catch(b){}else{d=document.createElement("link");if(!d.addBehavior){d=null;return}d.style.behavior="url(#default#userData)",document.getElementsByTagName("head")[0].appendChild(d),d.load("jStorage");var e="{}";try{e=d.getAttribute("jStorage")}catch(f){}c.jStorage=e,h="userDataBehavior"}j()}function j(){if(c.jStorage)try{b=g(String(c.jStorage))}catch(a){c.jStorage="{}"}else c.jStorage="{}";e=c.jStorage?String(c.jStorage).length:0}function k(){try{c.jStorage=f(b),d&&(d.setAttribute("jStorage",c.jStorage),d.save("jStorage")),e=c.jStorage?String(c.jStorage).length:0}catch(a){}}function l(a){if(!a||typeof a!="string"&&typeof a!="number")throw new TypeError("Key name must be string or numeric");return!0}if(!a||!(a.toJSON||Object.toJSON||window.JSON))throw new Error("jQuery, MooTools or Prototype needs to be loaded before jStorage!");var b={},c={jStorage:"{}"},d=null,e=0,f=a.toJSON||Object.toJSON||window.JSON&&(JSON.encode||JSON.stringify),g=a.evalJSON||window.JSON&&(JSON.decode||JSON.parse)||function(a){return String(a).evalJSON()},h=!1;_XMLService={isXML:function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1},encode:function(a){if(!this.isXML(a))return!1;try{return(new XMLSerializer).serializeToString(a)}catch(b){try{return a.xml}catch(c){}}return!1},decode:function(a){var b="DOMParser"in window&&(new DOMParser).parseFromString||window.ActiveXObject&&function(a){var b=new ActiveXObject("Microsoft.XMLDOM");return b.async="false",b.loadXML(a),b},c;return b?(c=b.call("DOMParser"in window&&new DOMParser||window,a,"text/xml"),this.isXML(c)?c:!1):!1}},a.jStorage={version:"0.1.5.1",set:function(a,c){return l(a),_XMLService.isXML(c)&&(c={_is_xml:!0,xml:_XMLService.encode(c)}),b[a]=c,k(),c},get:function(a,c){return l(a),a in b?b[a]&&typeof b[a]=="object"&&b[a]._is_xml&&b[a]._is_xml?_XMLService.decode(b[a].xml):b[a]:typeof c=="undefined"?null:c},deleteKey:function(a){return l(a),a in b?(delete b[a],k(),!0):!1},flush:function(){return b={},k(),!0},storageObj:function(){function a(){}return a.prototype=b,new a},index:function(){var a=[],c;for(c in b)b.hasOwnProperty(c)&&a.push(c);return a},storageSize:function(){return e},currentBackend:function(){return h},storageAvailable:function(){return!!h},reInit:function(){var a,b;if(d&&d.addBehavior){a=document.createElement("link"),d.parentNode.replaceChild(a,d),d=a,d.style.behavior="url(#default#userData)",document.getElementsByTagName("head")[0].appendChild(d),d.load("jStorage"),b="{}";try{b=d.getAttribute("jStorage")}catch(e){}c.jStorage=b,h="userDataBehavior"}j()}},i()}(window.jQuery||window.$),c.view.MemberList=Backbone.View.extend({tagName:"ul",events:{"click .nick":"nickClick"},initialize:function(a){this.model.bind("all",this.render,this),$(this.el).appendTo("#memberlists")},render:function(){var a=$(this.el);a.empty(),this.model.forEach(function(b){var c=(b.get("modes")||[]).join(" ");$('<li class="mode '+c+'"><a class="nick"><span class="prefix">'+b.get("prefix")+"</span>"+b.get("nick")+"</a></li>").appendTo(a).data("member",b)})},nickClick:function(a){var b=$(a.currentTarget).parent("li"),d=b.data("member"),e;if(b.find(".userbox").length>0){$(".userbox",this.$el).remove();return}e=new c.view.UserBox,e.member=d,$(".userbox",this.$el).remove(),b.append(e.$el)},show:function(){$("#memberlists").children().removeClass("active"),$(this.el).addClass("active")}}),c.view.UserBox=Backbone.View.extend({events:{"click .query":"queryClick","click .info":"infoClick","click .slap":"slapClick"},initialize:function(){this.$el=$($("#tmpl_userbox").html())},queryClick:function(a){var b=new c.model.Query({name:this.member.get("nick")});c.app.panels.add(b),b.view.show()},infoClick:function(a){c.app.controlbox.processInput("/whois "+this.member.get("nick"))},slapClick:function(a){c.app.controlbox.processInput("/slap "+this.member.get("nick"))}}),c.view.NickChangeBox=Backbone.View.extend({events:{submit:"changeNick","click .cancel":"close"},initialize:function(){this.$el=$($("#tmpl_nickchange").html())},render:function(){c.app.controlbox.$el.prepend(this.$el),this.$el.find("input").focus(),this.$el.css("bottom",c.app.controlbox.$el.outerHeight(!0))},close:function(){this.$el.remove()},changeNick:function(a){var b=this;return c.gateway.changeNick(this.$el.find("input").val(),function(a,c){b.close()}),!1}}),c.view.ServerSelect=function(){var a="all",b=Backbone.View.extend({events:{"submit form":"submitForm","click .show_more":"showMore","change .have_pass input":"showPass"},initialize:function(){var a=this;this.$el=$($("#tmpl_server_select").html()),c.app.server_settings&&c.app.server_settings.connection&&(c.app.server_settings.connection.allow_change||(this.$el.find(".show_more").remove(),this.$el.addClass("single_server"))),c.gateway.bind("onconnect",this.networkConnected,this),c.gateway.bind("connecting",this.networkConnecting,this),c.gateway.bind("onirc_error",function(b){$("button",this.$el).attr("disabled",null),b.error=="nickname_in_use"&&(this.setStatus("Nickname already taken"),this.show("nick_change")),b.error=="password_mismatch"&&(this.setStatus("Incorrect Password"),this.show("nick_change"),a.$el.find(".password").select())},this)},submitForm:function(b){b.preventDefault();if(!$("input.nick",this.$el).val().trim()){this.setStatus("Select a nickname first!"),$("input.nick",this.$el).select();return}a==="nick_change"?this.submitNickChange(b):this.submitLogin(b),$("button",this.$el).attr("disabled",1);return},submitLogin:function(a){if($("button",this.$el).attr("disabled"))return;var b={nick:$("input.nick",this.$el).val(),server:$("input.server",this.$el).val(),port:$("input.port",this.$el).val(),ssl:$("input.ssl",this.$el).prop("checked"),password:$("input.password",this.$el).val(),channel:$("input.channel",this.$el).val(),channel_key:$("input.channel_key",this.$el).val()};this.trigger("server_connect",b)},submitNickChange:function(a){c.gateway.changeNick($("input.nick",this.$el).val()),this.networkConnecting()},showPass:function(a){this.$el.find("tr.have_pass input").is(":checked")?this.$el.find("tr.pass").show().find("input").focus():this.$el.find("tr.pass").hide().find("input").val("")},showMore:function(a){$(".more",this.$el).slideDown("fast"),$("input.server",this.$el).select()},populateFields:function(a){var b,c,d,e,f,g,h;a=a||{},b=a.nick||"",c=a.server||"",d=a.port||6667,g=a.ssl||0,h=a.password||"",e=a.channel||"",f=a.channel_key||"",$("input.nick",this.$el).val(b),$("input.server",this.$el).val(c),$("input.port",this.$el).val(d),$("input.ssl",this.$el).prop("checked",g),$("input.password",this.$el).val(h),$("input.channel",this.$el).val(e),$("input.channel_key",this.$el).val(f)},hide:function(){this.$el.slideUp()},show:function(b){b=b||"all",this.$el.show(),b==="all"?$(".show_more",this.$el).show():b==="more"?$(".more",this.$el).slideDown("fast"):b==="nick_change"&&($(".more",this.$el).hide(),$(".show_more",this.$el).hide(),$("input.nick",this.$el).select()),a=b},setStatus:function(a,b){$(".status",this.$el).text(a).attr("class","status").addClass(b||"").show()},clearStatus:function(){$(".status",this.$el).hide()},networkConnected:function(a){this.setStatus("Connected :)","ok"),$("form",this.$el).hide()},networkConnecting:function(a){this.setStatus("Connecting..","ok")},showError:function(a){this.setStatus("Error connecting","error"),$("button",this.$el).attr("disabled",null),this.show()}});return new b(arguments)},c.view.Panel=Backbone.View.extend({tagName:"div",className:"messages",events:{"click .chan":"chanClick","click .media .open":"mediaClick","mouseenter .msg .nick":"msgEnter","mouseleave .msg .nick":"msgLeave"},initialize:function(a){this.initializePanel(a)},initializePanel:function(a){this.$el.css("display","none"),a=a||{},a.container?this.$container=$(a.container):this.$container=$("#panels .container1"),this.$el.appendTo(this.$container),this.alert_level=0,this.model.bind("msg",this.newMsg,this),this.msg_count=0,this.model.set({view:this},{silent:!0})},render:function(){var a=this;this.$el.empty(),_.each(this.model.get("scrollback"),function(b){a.newMsg(b)})},newMsg:function(a){var b,d,e=this.$el,f,g,h,k="";(new RegExp("\\b"+c.gateway.get("nick")+"\\b","i")).test(a.msg)&&(h=!0,k+=" highlight"),a.msg=$("<div />").text(a.msg).html(),b=new RegExp("(?:^|\\s)(["+c.gateway.get("channel_prefix")+"][^ ,.\\007]+)","g"),a.msg=a.msg.replace(b,function(a){return'<a class="chan" data-channel="'+a.trim()+'">'+a+"</a>"}),a.msg=a.msg.replace(/(([A-Za-z0-9\-]+\:\/\/)|(www\.))([\w.\-]+)([a-zA-Z]{2,6})(:[0-9]+)?(\/[\w#!:.?$'()[\]*,;~+=&%@!\-\/]*)?/gi,function(a){var b=a,d="";return a.match(/^www\./)&&(a="http://"+a),b.length>100&&(b=b.substr(0,100)+"..."),d=c.view.MediaMessage.buildHtml(a),'<a class="link_ext" target="_blank" rel="nofollow" href="'+a+'">'+b+"</a> "+d}),a.msg=j(a.msg),f=function(a){var b=0,c;return _.map(a.split(""),function(a){b+=a.charCodeAt(0)}),c=i(b%255,70,35),c=c[2]|c[1]<<8|c[0]<<16,"#"+c.toString(16)}(a.nick),a.nick_style="color:"+f+";",g=a.nick_css_class="",a.nick&&(_.map(a.nick.split(""),function(a){g+=a.charCodeAt(0).toString(16)}),k+=" nick_"+g),a.msg_css_classes=k,d='<div class="msg <%= type %> <%= msg_css_classes %>"><div class="time"><%- time %></div><div class="nick" style="<%= nick_style %>"><%- nick %></div><div class="text" style="<%= style %>"><%= msg %> </div></div>',e.append(_.template(d,a)),a.type.match(/^action /)?this.alert("action"):h?(c.app.view.alertWindow("* People are talking!"),this.alert("highlight")):(this.model.isActive()&&c.app.view.alertWindow("* People are talking!"),this.alert("activity")),function(){if(this.model.isActive())return;var a=this.model.tab.find(".activity");a.text((parseInt(a.text(),10)||0)+1),a.text()==="0"?a.addClass("zero"):a.removeClass("zero")}.apply(this),this.scrollToBottom(),this.msg_count++,this.msg_count>(parseInt(c.global.settings.get("scrollback"),10)||250)&&($(".msg:first",this.$el).remove(),this.msg_count--)},chanClick:function(a){a.target?c.gateway.join($(a.target).data("channel")):c.gateway.join($(a.srcElement).data("channel"))},mediaClick:function(a){var b=$(a.target).parents(".media"),d;b.data("media")?d=b.data("media"):(d=new c.view.MediaMessage({el:b[0]}),b.data("media",d)),b.data("media",d),d.open()},msgEnter:function(a){var b;_.each($(a.currentTarget).parent(".msg").attr("class").split(" "),function(a){a.match(/^nick_[a-z0-9]+/i)&&(b=a)});if(!b)return;$("."+b).addClass("global_nick_highlight")},msgLeave:function(a){var b;_.each($(a.currentTarget).parent(".msg").attr("class").split(" "),function(a){a.match(/^nick_[a-z0-9]+/i)&&(b=a)});if(!b)return;$("."+b).removeClass("global_nick_highlight")},show:function(){var a=this.$el;this.$container.children().css("display","none"),a.css("display","block");var b=this.model.get("members");b?($("#memberlists").removeClass("disabled"),b.view.show()):$("#memberlists").addClass("disabled").children().removeClass("active"),c.app.view.doLayout(),this.alert("none"),this.model.tab.find(".activity").text("0").addClass("zero"),this.trigger("active",this.model),c.app.panels.trigger("active",this.model,c.app.panels.active),this.scrollToBottom(!0)},alert:function(a){if(this.model==c.app.panels.active)return;var b,d;b=["none","action","activity","highlight"],a=a||"none",d=_.indexOf(b,a),d||(a="none",d=0);if(d!==0&&d<=this.alert_level)return;this.model.tab.removeClass(function(a,b){return(b.match(/\balert_\S+/g)||[]).join(" ")}),a!=="none"&&this.model.tab.addClass("alert_"+a),this.alert_level=d},scrollToBottom:function(a){if(this.model!==c.app.panels.active)return;if(a||this.$container.scrollTop()+this.$container.height()>this.$el.outerHeight()-150)this.$container[0].scrollTop=this.$container[0].scrollHeight}}),c.view.Applet=c.view.Panel.extend({className:"applet",initialize:function(a){this.initializePanel(a)}}),c.view.Channel=c.view.Panel.extend({initialize:function(a){this.initializePanel(a),this.model.bind("change:topic",this.topic,this),this.model.isChannel()&&this.$el.append('<div class="initial_loader" style="margin:1em;text-align:center;">Joining channel.. <span class="loader"></span></div>')},newMsg:function(){return this.$el.find(".initial_loader").slideUp(function(){$(this).remove()}),this.constructor.__super__.newMsg.apply(this,arguments)},topic:function(a){if(typeof a!="string"||!a)a=this.model.get("topic");this.model.addMsg("","== Topic for "+this.model.get("name")+" is: "+a,"topic"),c.app.panels.active===this&&c.app.topicbar.setCurrentTopic(this.model.get("topic"))}}),c.view.Tabs=Backbone.View.extend({events:{"click li":"tabClick","click li .part":"partClick"},initialize:function(){this.model.on("add",this.panelAdded,this),this.model.on("remove",this.panelRemoved,this),this.model.on("reset",this.render,this),this.model.on("active",this.panelActive,this),this.tabs_applets=$("ul.applets",this.$el),this.tabs_msg=$("ul.channels",this.$el),c.gateway.on("change:name",function(a,b){$("span",this.model.server.tab).text(b)},this)},render:function(){var a=this;this.tabs_msg.empty(),this.model.server.tab.data("panel_id",this.model.server.cid).appendTo(this.tabs_msg),this.model.forEach(function(b){if(b==a.model.server)return;b.tab.data("panel_id",b.cid).appendTo(b.isApplet()?this.tabs_applets:this.tabs_msg)}),c.app.view.doLayout()},updateTabTitle:function(a,b){$("span",a.tab).text(b)},panelAdded:function(a){a.tab=$("<li><span>"+(a.get("title")||a.get("name"))+'</span><div class="activity"></div></li>'),a.isServer()&&a.tab.addClass("server"),a.tab.data("panel_id",a.cid).appendTo(a.isApplet()?this.tabs_applets:this.tabs_msg),a.bind("change:title",this.updateTabTitle),c.app.view.doLayout()},panelRemoved:function(a){a.tab.remove(),delete a.tab,c.app.view.doLayout()},panelActive:function(a,b){$(".part",this.$el).remove(),this.tabs_applets.children().removeClass("active"),this.tabs_msg.children().removeClass("active"),a.tab.addClass("active"),a.isServer()||a.tab.append('<span class="part"></span>')},tabClick:function(a){var b=$(a.currentTarget),c=this.model.getByCid(b.data("panel_id"));if(!c)return;c.view.show()},partClick:function(a){var b=$(a.currentTarget).parent(),d=this.model.getByCid(b.data("panel_id"));d.isChannel()&&d.get("members").models.length>0?c.gateway.part(d.get("name")):d.close()},next:function(){var a=c.app.panels.active.tab.next();a.length||(a=$("li:first",this.tabs_msgs)),a.click()},prev:function(){var a=c.app.panels.active.tab.prev();a.length||(a=$("li:last",this.tabs_msgs)),a.click()}}),c.view.TopicBar=Backbone.View.extend({events:{"keydown div":"process"},initialize:function(){c.app.panels.bind("active",function(a){a.isChannel()?(this.setCurrentTopic(a.get("topic")||""),this.$el.find("div").attr("contentEditable",!0)):this.$el.find("div").attr("contentEditable",!1).text("")},this)},process:function(a){var b=$(a.currentTarget),d=b.text();if(!c.app.panels.active.isChannel())return!1;if(a.keyCode===13)return c.gateway.topic(c.app.panels.active.get("name"),d),!1},setCurrentTopic:function(a){a=a||"",$("div",this.$el).html(j(_.escape(a)))}}),c.view.ControlBox=Backbone.View.extend({events:{"keydown .inp":"process","click .nick":"showNickChange"},initialize:function(){var a=this;this.buffer=[],this.buffer_pos=0,this.preprocessor=new h,this.preprocessor.recursive_depth=5,this.tabcomplete={active:!1,data:[],prefix:""},c.gateway.bind("change:nick",function(){$(".nick",a.$el).text(this.get("nick"))})},showNickChange:function(a){(new c.view.NickChangeBox).render()},process:function(a){var b=this,d=$(a.currentTarget),e=d.val(),f;navigator.appVersion.indexOf("Mac")!==-1?f=a.metaKey:f=a.altKey,this.tabcomplete.active&&a.keyCode!==9&&(this.tabcomplete.active=!1,this.tabcomplete.data=[],this.tabcomplete.prefix="");switch(!0){case a.keyCode===13:return e=e.trim(),e&&($.each(e.split("\n"),function(a,c){b.processInput(c)}),this.buffer.push(e),this.buffer_pos=this.buffer.length),d.val(""),!1;case a.keyCode===38:this.buffer_pos>0&&(this.buffer_pos--,d.val(this.buffer[this.buffer_pos]));break;case a.keyCode===40:this.buffer_pos<this.buffer.length&&(this.buffer_pos++,d.val(this.buffer[this.buffer_pos]));break;case a.keyCode===219&&f:return c.app.panels.view.prev(),!1;case a.keyCode===221&&f:return c.app.panels.view.next(),!1;case a.keyCode===9:this.tabcomplete.active=!0;if(_.isEqual(this.tabcomplete.data,[])){var g=[];$.each(c.app.panels.active.get("members").models,function(a,b){if(!b)return;g.push(b.get("nick"))}),g=_.sortBy(g,function(a){return a}),this.tabcomplete.data=g}if(e[d[0].selectionStart-1]===" ")return!1;return function(){var a=e.substring(0,d[0].selectionStart).split(" "),c,f,g,h,i=a[a.length-1];this.tabcomplete.prefix===""&&(this.tabcomplete.prefix=i),this.tabcomplete.data=_.select(this.tabcomplete.data,function(a){return a.toLowerCase().indexOf(b.tabcomplete.prefix.toLowerCase())===0}),this.tabcomplete.data.length>0&&(f=d[0].selectionStart-i.length,c=e.substr(0,f),g=this.tabcomplete.data.shift(),this.tabcomplete.data.push(g),c+=g,c+=e.substr(d[0].selectionStart),d.val(c),d[0].setSelectionRange?d[0].setSelectionRange(f+g.length,f+g.length):d[0].createTextRange&&(h=d[0].createTextRange(),h.collapse(!0),h.moveEnd("character",f+g.length),h.moveStart("character",f+g.length),h.select()))}.apply(this),!1}},processInput:function(a){var b,d,e;if(a[0]!=="/"||a.substr(0,2)==="//")a=a.replace(/^\/\//,"/"),a="/msg "+c.app.panels.active.get("name")+" "+a;this.preprocessor.vars.server=c.gateway.get("name"),this.preprocessor.vars.channel=c.app.panels.active.get("name"),this.preprocessor.vars.destination=this.preprocessor.vars.channel,a=this.preprocessor.process(a),d=a.split(" "),d[0][0]==="/"?(b=d[0].substr(1).toLowerCase(),d=d.splice(1,d.length-1)):(b="msg",d.unshift(c.app.panels.active.get("name"))),this.trigger("command",{command:b,params:d}),this.trigger("command:"+b,{command:b,params:d}),this._callbacks["command:"+b]||this.trigger("unknown_command",{command:b,params:d})}}),c.view.StatusMessage=Backbone.View.extend({initialize:function(){this.$el.hide(),this.tmr=null},text:function(a,b){b=b||{},b.type=b.type||"",b.timeout=b.timeout||5e3,this.$el.text(a).attr("class",b.type),this.$el.slideDown(c.app.view.doLayout),b.timeout&&this.doTimeout(b.timeout)},html:function(a,b){b=b||{},b.type=b.type||"",b.timeout=b.timeout||5e3,this.$el.html(text).attr("class",b.type),this.$el.slideDown(c.app.view.doLayout),b.timeout&&this.doTimeout(b.timeout)},hide:function(){this.$el.slideUp(c.app.view.doLayout)},doTimeout:function(a){this.tmr&&clearTimeout(this.tmr);var b=this;this.tmr=setTimeout(function(){b.hide()},a)}}),c.view.ResizeHandler=Backbone.View.extend({events:{mousedown:"startDrag",mouseup:"stopDrag"},initialize:function(){this.dragging=!1,this.starting_width={},$(window).on("mousemove",$.proxy(this.onDrag,this))},startDrag:function(a){this.dragging=!0},stopDrag:function(a){this.dragging=!1},onDrag:function(a){if(!this.dragging)return;this.$el.css("left",a.clientX-this.$el.outerWidth(!0)/2),$("#memberlists").css("width",this.$el.parent().width()-(this.$el.position().left+this.$el.outerWidth())),c.app.view.doLayout()}}),c.view.AppToolbar=Backbone.View.extend({events:{"click .settings":"clickSettings"},initialize:function(){},clickSettings:function(a){c.app.controlbox.processInput("/settings")}}),c.view.Application=Backbone.View.extend({initialize:function(){$(window).resize(this.doLayout),$("#toolbar").resize(this.doLayout),$("#controlbox").resize(this.doLayout),c.global.settings.on("change:theme",this.updateTheme,this),this.updateTheme(getQueryVariable("theme")),c.global.settings.on("change:channel_list_style",this.setTabLayout,this),this.setTabLayout(c.global.settings.get("channel_list_style")),this.doLayout(),$(document).keydown(this.setKeyFocus),window.onbeforeunload=function(){if(c.gateway.isConnected())return"This will close all KiwiIRC conversations. Are you sure you want to close this window?"}},updateTheme:function(a){a===c.global.settings&&(a=arguments[1]),a||(a=c.global.settings.get("theme")),this.$el.removeClass(function(a,b){return(b.match(/\btheme_\S+/g)||[]).join(" ")}),this.$el.addClass("theme_"+(a||"relaxed"))},setTabLayout:function(a){a===c.global.settings&&(a=arguments[1]),a=="list"?this.$el.addClass("chanlist_treeview"):this.$el.removeClass("chanlist_treeview"),this.doLayout()},setKeyFocus:function(a){if(a.ctrlKey||a.altKey||a.metaKey)return;if(a.target.tagName.toLowerCase()==="input"||a.target.tagName.toLowerCase()==="textarea"||$(a.target).attr("contenteditable"))return;$("#controlbox .inp").focus()},doLayout:function(){var a=$("#kiwi"),b=$("#panels"),c=$("#memberlists"),d=$("#toolbar"),e=$("#controlbox"),f=$("#memberlists_resize_handle"),g={top:d.outerHeight(!0),bottom:e.outerHeight(!0)};d.is(":visible")||(g.top=0),e.is(":visible")||(g.bottom=0),b.css(g),c.css(g),f.css(g),a.hasClass("chanlist_treeview")&&$("#kiwi #tabs").css(g),a.outerWidth()<400?a.addClass("narrow"):a.removeClass("narrow"),c.css("display")!="none"?(b.css("right",c.outerWidth(!0)),f.css("left",c.position().left-f.outerWidth(!0)/2)):(b.css("right",0),f.css("left",b.outerWidth(!0)))},alertWindow:function(a){this.alertWindowTimer||(this.alertWindowTimer=new function(){var a=this,b,c=!0,d=0,e="Kiwi IRC",f="Kiwi IRC";this.setTitle=function(a){return a=a||e,window.document.title=a,a},this.start=function(a){if(c)return;f=a;if(b)return;b=setInterval(this.update,1e3)},this.stop=function(){b&&clearInterval(b),b=null,this.setTitle(),setTimeout(this.reset,2e3)},this.reset=function(){if(b)return;a.setTitle()},this.update=function(){d===0?(a.setTitle(f),d=1):(a.setTitle(),d=0)},$(window).focus(function(b){c=!0,a.stop(),setTimeout(a.reset,2e3)}),$(window).blur(function(a){c=!1})}),this.alertWindowTimer.start(a)},barsHide:function(a){var b=this;a?($("#toolbar").slideUp(0),$("#controlbox").slideUp(0),this.doLayout()):($("#toolbar").slideUp({queue:!1,duration:400,step:this.doLayout}),$("#controlbox").slideUp({queue:!1,duration:400,step:this.doLayout}))},barsShow:function(a){var b=this;a?($("#toolbar").slideDown(0),$("#controlbox").slideDown(0),this.doLayout()):($("#toolbar").slideDown({queue:!1,duration:400,step:this.doLayout}),$("#controlbox").slideDown({queue:!1,duration:400,step:this.doLayout}))}}),c.view.MediaMessage=Backbone.View.extend({events:{"click .media_close":"close"},initialize:function(){this.url=this.$el.data("url")},close:function(){var a=this;this.$content.slideUp("fast",function(){a.$content.remove()})},open:function(){this.$content||(this.$content=$('<div class="media_content"><a class="media_close"><i class="icon-chevron-up"></i> Close media</a><br /><div class="content"></div></div>'),this.$content.find(".content").append(this.mediaTypes[this.$el.data("type")].apply(this,[])||"Not found :(")),this.$content.is(":visible")||(this.$content.hide(),this.$el.append(this.$content),this.$content.slideDown())},mediaTypes:{twitter:function(){var a=this.$el.data("tweetid"),b=this;return $.getJSON("https://api.twitter.com/1/statuses/oembed.json?id="+a+"&callback=?",function(a){b.$content.find(".content").html(a.html)}),$("<div>Loading tweet..</div>")},image:function(){return $('<a href="'+this.url+'" target="_blank"><img height="100" src="'+this.url+'" /></a>')},reddit:function(){var a=this,b=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(this.url);return $.getJSON("http://www."+b[0]+".json?jsonp=?",function(b){console.log("Loaded reddit data",b);var c=b[0].data.children[0].data,d="";c.thumbnail&&(c.over_18?(d="<span class=\"thumbnail_nsfw\" onclick=\"$(this).find('p').remove(); $(this).find('img').css('visibility', 'visible');\">",d+='<p style="font-size:0.9em;line-height:1.2em;cursor:pointer;">Show<br />NSFW</p>',d+='<img src="'+c.thumbnail+'" class="thumbnail" style="visibility:hidden;" />',d+="</span>"):d='<img src="'+c.thumbnail+'" class="thumbnail" />');var e="<div>"+d+"<b><%- title %></b><br />Posted by <%- author %>. &nbsp;&nbsp; ";e+='<i class="icon-arrow-up"></i> <%- ups %> &nbsp;&nbsp; <i class="icon-arrow-down"></i> <%- downs %><br />',e+='<%- num_comments %> comments made. <a href="http://www.reddit.com<%- permalink %>">View post</a></div>',a.$content.find(".content").html(_.template(e,c))}),$("<div>Loading Reddit thread..</div>")}}},{buildHtml:function(a){var b="",c;return a.match(/(\.jpe?g|\.gif|\.bmp|\.png)\??$/i)&&(b+='<span class="media image" data-type="image" data-url="'+a+'" title="Open Image"><a class="open"><i class="icon-chevron-right"></i></a></span>'),c=/https?:\/\/twitter.com\/([a-zA-Z0-9_]+)\/status\/([0-9]+)/ig.exec(a),c&&(b+='<span class="media twitter" data-type="twitter" data-url="'+a+'" data-tweetid="'+c[2]+'" title="Show tweet information"><a class="open"><i class="icon-chevron-right"></i></a></span>'),c=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(a),c&&(b+='<span class="media reddit" data-type="reddit" data-url="'+a+'" title="Reddit thread"><a class="open"><i class="icon-chevron-right"></i></a></span>'),b}})})(window)